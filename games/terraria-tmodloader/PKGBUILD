# Maintainer: Hoream <hoream@qq.com>

tmlver="2023.09.3.0"
terrariaver="1.4.4.9"
pkgrel=1
epoch=0

pkgname="terraria-tmodloader"
pkgdesc="An open-source, community-driven, modification and expansion of the Terraria game that makes it possible to make and play mods."
pkgver="$tmlver"_"$terrariaver"
url="https://www.tmodloader.net/"
arch=("x86_64")
license=("MIT")
depends=('unzip>=6.0' 'terraria' 'sdl2')
provides=('tmodloader')
conflicts=('tmodloader' 'tmodloader-bin')

source=(
  "tml-$tmlver.zip::https://github.com/tModLoader/tModLoader/releases/download/v$tmlver/tModLoader.zip"
)

sha256sums=(
  "1b3fb0318bdb0ab6aaf326a2fe018dd3599e64c770d9522030384a5643bc5cb9"
)

package() {
    _install_dir="${pkgdir}/opt/gog/terraria/game/tModLoader"
    install -d ${_install_dir}
    cp "${srcdir}"/* ${_install_dir}/ -r
    rm ${_install_dir}/tml-$tmlver.zip
    chmod a+x ${_install_dir}/*.sh
    chmod a+x ${_install_dir}/LaunchUtils/*.sh

    # enable wayland support
    sed -i '2i\
if [ "$XDG_SESSION_TYPE" = "wayland" ]; then\
    export SDL_VIDEODRIVER=wayland\
    export SDL_DYNAMIC_API="/usr/lib/libSDL2-2.0.so"\
else \
    export SDL_VIDEODRIVER=x11\
fi
' "${_install_dir}/start-tModLoader.sh"

    # copy Terraria.exe
    ln -sf /opt/gog/terraria/game/Terraria.exe "${pkgdir}"/opt/gog/terraria/game/Terraria_v${terrariaver}.exe

}
