# Maintainer: Fabio 'Lolix' Loli <fabio.loli@disroot.org> -> https://github.com/FabioLolix
# Contributor: Florian Will <florian dot will at gmail dot com>
# Contributor: Drew DeVore <w.drew.devore at gmail dot com>

pkgname=gmrender-resurrect-git
pkgver=r351.e1fed36
pkgrel=2
epoch=1
pkgdesc="Application to stream music from a UPnP server using gstreamer."
arch=(x86_64 i686 i486 pentium4 arm armv6h armv7h aarch64)
url="https://github.com/hzeller/gmrender-resurrect"
license=(GPL2)
depends=(libupnp gst-plugins-good gst-plugins-base mpv)
optdepends=('gst-libav: Extra media codecs'
            'gst-plugins-bad: Extra media codecs'
            'gst-plugins-ugly: Extra media codecs')
makedepends=(git)
backup=('etc/conf.d/gmediarender')
install='gmrender-resurrect.install'
provides=(gmediarender)
conflicts=(gmediarender)
source=("git+https://github.com/zangloo/gmrender-resurrect.git"
        'gmediarender.service'
	    'gmediarender-user.service'
	    'gmediarender')
sha256sums=('SKIP'
            '28d9a61adc76448e7e4458e77239394be4292c04176826615adf4099d0938b66'
            '21ddcc23cec7bb7b6b6f81e5fc74913c5f6e792ec6f57fd657782e43b2079041'
            '089b0d0854a8e74cdc9aca096b08088bb24a2c457f50b1b7146f0fa2ec2bfb69')

pkgver() {
  cd "${pkgname%-git}"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${pkgname%-git}"
  sed -i '/mpv_set_option_string(handle, "input-vo-keyboard", "yes");/a\        mpv_set_option_string(handle, "config", "yes");' src/output_mpv.c
  ./autogen.sh
}

build() {
  cd "${pkgname%-git}"
  ./configure --prefix=/usr/ --datadir=/usr/share --with-mpv --without-gstreamer
  make
}

package() {
  cd "${pkgname%-git}"
  make DESTDIR=${pkgdir} install
  install -Dm644 $srcdir/gmediarender.service "${pkgdir}/usr/lib/systemd/system/gmediarender.service"
  install -Dm644 $srcdir/gmediarender-user.service "${pkgdir}/usr/lib/systemd/user/gmediarender.service"
  install -Dm644 $srcdir/gmediarender "${pkgdir}/etc/conf.d/gmediarender"
}
