# Maintainer: Hoream <hoream@qq.com>
# Contributor: Solomon Choina <shlomochoina@gmail.com0
pkgname=wayfire-hoream-git
pkgver=0.8.0.20240509.023836.g83daa255
pkgrel=7
pkgdesc="3D wayland compositor (hoream's version)"
arch=('x86_64')
url="https://github.com/xiaohuirong/wayfire"
license=('MIT')
depends=('wlroots-hoream-git' 'cairo' 'pango' 'glm' 'libjpeg' 'wf-config-hoream-git' 'seatd')
makedepends=('git' 'meson' 'ninja' 'wayland-protocols' 'doctest' 'cmake')
optdepends=('wf-shell-hoream-git: GTK3-based panel for the Wayfire compositor'
            'wf-sound-control-git: Small utility for the Wayfire compositor to control sound volume')
provides=(wayfire wayfire-git)
conflicts=(wayfire wayfire-git)
replaces=()
options=(debug)
source=(wayfire::git+$url.git#branch=hoream
        wf-touch::git+https://github.com/WayfireWM/wf-touch
        wf-utils::git+https://github.com/WayfireWM/wf-utils
        wlroots::git+https://github.com/xiaohuirong/wlroots
        sdl_decor.patch
        decoration.patch
        fix_wofi_crash.patch
        xwayland_no_mapped.patch
        fix_mirror_crash.patch
        support_custom_modes.patch
        wlr_custom_output.patch)
sha256sums=(SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP
            SKIP)

prepare() {
    cd "$srcdir/wayfire"
    git config submodule.subprojects/wf-touch.url "${srcdir}/wf-touch"
    git -c protocol.file.allow=always submodule update --init subprojects/wf-touch

    git config submodule.subprojects/wf-utils.url "${srcdir}/wf-utils"
    git -c protocol.file.allow=always submodule update --init subprojects/wf-utils

    git config submodule.subprojects/wlroots.url "${srcdir}/wlroots"
    git -c protocol.file.allow=always submodule update --init subprojects/wlroots
}

pkgver () {
    cd "$srcdir/wayfire"
    (
        set -o pipefail
        version=$(grep -zoP "project\([^)]*\)" meson.build | xargs --null echo | grep -oP "^\sversion:\s'\K[^']*")
        printf "${version}.%s.g%s" "$(TZ=UTC git log -1 --pretty='%cd' --date=format-local:%Y%m%d.%H%M%S)" "$(git log -1 --format='%h')"
    )
}

build() {
    cd "$srcdir/wayfire"
    # debug_ipc doesn't compile with wlroots 0.16.0
    arch-meson \
        --buildtype=release \
        -Duse_system_wlroots=enabled \
        -Duse_system_wfconfig=enabled \
        -Dtests=disabled \
        -Ddebug_ipc=false \
        . \
        build
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/decoration.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/sdl_decor.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/fix_wofi_crash.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/xwayland_no_mapped.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/fix_mirror_crash.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/support_custom_modes.patch
    patch -b -d ${srcdir}/wayfire -Np1 -i ${srcdir}/wlr_custom_output.patch
    ninja -C build
}

package() {
    cd "$srcdir/wayfire"
    DESTDIR="${pkgdir}/" ninja -C build install
    install -m644 wayfire.ini "${pkgdir}/usr/share"
}

